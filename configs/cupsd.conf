# ================================
# CUPS 配置文件
# 目标：保留手机局域网打印（IPP/631）、Web管理界面、打印机广播，同时支持小程序后台打印（lp命令）
# 安全策略：限制管理权限，仅允许系统用户和打印拥有者执行敏感操作
# ================================

# 日志等级
LogLevel warn

# 页面日志格式（可选，可留空）
PageLogFormat

# 不限制日志文件大小
MaxLogSize 0

# =========================
# 监听设置
# =========================

# 必须监听 631 端口，否则手机无法通过 IPP 协议打印，您也无法使用浏览器访问管理界面
Port 631

# 可选：如果您还想支持本地 unix socket 方式（例如命令行测试 lp），可以加上：
# Listen /run/cups/cups.sock

# =========================
# 是否允许浏览器访问 CUPS 管理界面
# =========================

# ✅ 必须为 Yes，否则无法通过浏览器访问 http://<打印机IP>:631
WebInterface Yes

# =========================
# 打印机广播（局域网设备自动发现 CUPS 打印机）
# =========================

# ✅ 必须为 On，否则手机或其他电脑无法自动发现这台打印机
Browsing On

# ✅ 使用默认的 dnssd 协议进行广播（局域网发现）
BrowseLocalProtocols dnssd

# =========================
# 访问控制：禁止未经授权的访问
# =========================

# 根路径，拒绝所有浏览器直接访问 CUPS（可选，如果您希望完全禁用根路径访问，可启用，但一般不必要）
# <Location />
#   Order allow,deny
#   Deny from all
# </Location>

# 更推荐的方式是：**放行必要的访问，但对管理类路径做严格限制**

# =========================
# 管理相关路径的访问控制
# =========================

# 允许所有人访问主页面（打印队列等基础功能），但管理功能受限（通过下面的 Policy 实现）
<Location />
  Order allow,deny
  Allow all
</Location>

# 禁止非系统用户访问管理后台（/admin）
<Location /admin>
  Order allow,deny
  # 如果您希望只有本地或某些 IP 能访问管理后台，可以在这里加 Allow 127.0.0.1 或 Allow 您的IP
  # 现在我们允许所有人访问，但通过 Policy 限制能做什么
  Allow all
</Location>

# 禁止非系统用户修改 CUPS 配置（/admin/conf）
<Location /admin/conf>
  Order allow,deny
  Allow all
  # 实际权限由下面的 Policy 控制，仅允许 @SYSTEM
</Location>

# 禁止非系统用户查看日志（/admin/log）
<Location /admin/log>
  Order allow,deny
  Allow all
  # 实际权限由下面的 Policy 控制，仅允许 @SYSTEM
</Location>

# =========================
# 安全策略定义
# =========================

# 默认策略：适用于所有用户，限制敏感操作
<Policy default>
  JobPrivateAccess default
  JobPrivateValues default
  SubscriptionPrivateAccess default
  SubscriptionPrivateValues default

  # 允许：创建任务、提交打印任务（由用户或 app 提出）
  <Limit Create-Job Print-Job Print-URI Validate-Job>
    Order allow,deny
    Allow all
  </Limit>

  # 限制：只有任务拥有者 (@OWNER) 或系统 (@SYSTEM) 能真正发送文档、控制任务
  <Limit Send-Document Send-URI Hold-Job Release-Job Restart-Job Purge-Jobs Set-Job-Attributes Create-Job-Subscription Renew-Subscription Cancel-Subscription Get-Notifications Reprocess-Job Cancel-Current-Job Suspend-Current-Job Resume-Job Cancel-My-Jobs Close-Job CUPS-Move-Job>
    Require user @OWNER @SYSTEM
    Order allow,deny
  </Limit>

  # 允许打印任务拥有者获取打印文档
  <Limit CUPS-Get-Document>
    Require user @OWNER @SYSTEM
    Order allow,deny
  </Limit>

  # 限制：只有系统管理员能修改打印机配置、添加/删除打印机
  <Limit CUPS-Add-Modify-Printer CUPS-Delete-Printer CUPS-Add-Modify-Class CUPS-Delete-Class CUPS-Set-Default CUPS-Get-Devices>
    Require user @SYSTEM
    Order allow,deny
  </Limit>

  # 限制：只有系统管理员能暂停/启用打印机等操作
  <Limit Pause-Printer Resume-Printer Enable-Printer Disable-Printer Pause-Printer-After-Current-Job Hold-New-Jobs Release-Held-New-Jobs Deactivate-Printer Activate-Printer Restart-Printer Shutdown-Printer Startup-Printer Promote-Job Schedule-Job-After Cancel-Jobs CUPS-Accept-Jobs CUPS-Reject-Jobs>
    Require user @SYSTEM
    Order allow,deny
  </Limit>

  # 限制：只有任务拥有者或系统能取消任务
  <Limit Cancel-Job CUPS-Authenticate-Job>
    Require user @OWNER @SYSTEM
    Order allow,deny
  </Limit>

  # 默认拒绝其他未授权操作
  <Limit All>
    Order deny,allow
  </Limit>
</Policy>